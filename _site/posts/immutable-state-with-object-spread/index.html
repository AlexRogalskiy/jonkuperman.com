<!doctype html>
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-21008844-11"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-21008844-11');
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jon Kuperman</title>
    <meta name="Description" content="My personal website and blog.">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Jon Kuperman">
    <link rel="shortcut icon" href="/img/favicon.ico" />
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Jon Kuperman</a></h1>
      <ul class="nav"><li class="nav-item"><a href="/">Home</a></li><li class="nav-item"><a href="/posts/">Blog</a></li></ul>
    </header>

    <main class="tmpl-post">
      <div class="wrapper">
    <h1>Managing Immutable State with Object Spread</h1>

    <p>There are a lot of great libraries for managing immutable state in your web apps. <a href="https://redux.js.org/">Redux</a> and <a href="https://immerjs.github.io/immer/docs/introduction">Immer</a> are two great examples.</p>
<p>When workings with libraries like these, you often need to create functions that take in the current state object and a piece of new data and return a new state object for which the only difference is the piece of new data.</p>
<p>Let's look at a quick example:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  users<span class="token punctuation">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      name<span class="token punctuation">:</span> <span class="token string">"User 1"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      name<span class="token punctuation">:</span> <span class="token string">"User 2"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  topics<span class="token punctuation">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      title<span class="token punctuation">:</span> <span class="token string">"Topic 1"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      description<span class="token punctuation">:</span> <span class="token string">"My first topic"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      title<span class="token punctuation">:</span> <span class="token string">"Topic 2"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      description<span class="token punctuation">:</span> <span class="token string">"My second topic!"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  name<span class="token punctuation">:</span> <span class="token string">"User 3"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> <span class="token function-variable function">addUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> newUser</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> state<span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p>This works totally fine. But if we look at this line</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line">state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>We can see that we are <strong>mutating</strong> the state object, by pushing a new item onto the <code>users</code> array.</p>
<h2 id="mutable-vs-immutable">Mutable vs Immutable <a class="direct-link" href="#mutable-vs-immutable">#</a></h2>
<p>For those not familiar, let's take a look at what we mean by mutability. Say you have an array of numbers:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>And you want to add 1 to each number. You could do this by mutating or changing the existing array:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [2, 3, 4, 5, 6]</span></span></code></pre>
<p>Another approach we could take is to create a <strong>new</strong> array with our changes, while keeping the original one around. We can use a method like <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map">Array.prototype.map</a> to accomplish this.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> newArr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=></span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [2, 3, 4, 5, 6]</span></span><br><span class="highlight-line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [1, 2, 3, 4, 5]</span></span></code></pre>
<p>The second approach is what we'd consider immutable as we never change (or mutate) the original array.</p>
<h2 id="why-have-immutable-state%3F">Why have immutable state? <a class="direct-link" href="#why-have-immutable-state%3F">#</a></h2>
<p>Many popular libraries encourage an <strong>immutable</strong> approach to state for a few reasons.</p>
<ol>
<li><strong>Performance</strong>. View libraries like React which compute changes can move a lot faster with immutable data structures.</li>
<li><strong>Undo</strong>. Allowing users to &quot;undo&quot; an action is the holy grail of state management. With immmutable data structures, we can just keep the previous state around (or even just a log of state changes) and easily allow users to revert a change.</li>
<li><strong>Bugs</strong>. There are a whole category of bugs that can be caused when mutating an object directly. An immutable approach ensures there is never invalid state and in the worst case state can always be reverted.</li>
<li><strong>Testability</strong>. Immutable state changes are dead simple to test.</li>
</ol>
<h2 id="making-the-adduser-function-immutable-with-object-spread">Making the addUser function immutable with Object Spread <a class="direct-link" href="#making-the-adduser-function-immutable-with-object-spread">#</a></h2>
<p>One great language feature for this type of work is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax">spread syntax</a>. This allows us to write really clean code for immutable state operations that generate new objects comprised mostly of values of the original object. Let's take a look at our <code>addUser</code> function again.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="highlight-line"><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  users<span class="token punctuation">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      name<span class="token punctuation">:</span> <span class="token string">"User 1"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      name<span class="token punctuation">:</span> <span class="token string">"User 2"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  topics<span class="token punctuation">:</span> <span class="token punctuation">[</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      title<span class="token punctuation">:</span> <span class="token string">"Topic 1"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      description<span class="token punctuation">:</span> <span class="token string">"My first topic"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    <span class="token punctuation">{</span></span><br><span class="highlight-line">      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      title<span class="token punctuation">:</span> <span class="token string">"Topic 2"</span><span class="token punctuation">,</span></span><br><span class="highlight-line">      description<span class="token punctuation">:</span> <span class="token string">"My second topic!"</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span></span><br><span class="highlight-line">  <span class="token punctuation">]</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  id<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span></span><br><span class="highlight-line">  name<span class="token punctuation">:</span> <span class="token string">"User 3"</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> <span class="token function-variable function">addUser</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> newUser</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token operator">...</span>state<span class="token punctuation">,</span></span><br><span class="highlight-line">    users<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>state<span class="token punctuation">.</span>users<span class="token punctuation">,</span> newUser<span class="token punctuation">]</span></span><br><span class="highlight-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> newState <span class="token operator">=</span> <span class="token function">addUser</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> newUser<span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3 users</span></span><br><span class="highlight-line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// old state with 2 users</span></span></code></pre>


    <p><a href="/">← Home</a></p>
</div>

    </main>

    <!-- Current page: /posts/immutable-state-with-object-spread/ -->
  </body>
</html>
